# Автоматизация обработки данных геофизического метода МТЗ

## Обзор проекта

Проект представляет собой систему автоматизированной обработки данных магнитотеллурического зондиования (МТЗ). Данный метод позволяет определять электрическую проводимость горных пород на значительных глубинах и является ключевым для поиска полезных ископаемых и анализа структуры земной коры. Традиционно обработка таких данных выполняется вручную, что требует значительных временных затрат (20–60 минут на каждую точку измерения) и подвержено субъективным ошибкам оператора. Наше решение направлено на автоматизацию предобработки, строгую фильтрацию выбросов, сглаживание и интерполяцию данных, а также использование современных методов машинного обучения для классификации и интерпретации результатов.

## Цели и задачи

### Цели проекта

- **Ускорение обработки данных.** Автоматизация позволяет обрабатывать полевые данные за доли секунды вместо десятков минут.
- **Повышение точности интерпретации.** Применение интеллектуальной фильтрации выбросов и нейронных сетей обеспечивает корректное выделение основных трендов и устранение аномальных точек.
- **Снижение влияния человеческого фактора.** Автоматизация исключает субъективные ошибки, характерные для ручной обработки.

### Задачи проекта

- **Предобработка данных.** Разработка системы для расчёта комплексного импеданса, фазы и сопротивления по исходным измерениям. В частности:
  - Вычисление комплексного импеданса:
    $$
    Z = Re(Z) + j \cdot Im(Z)
    $$
  - Расчёт фазы:
    $$
    \phi = \arctan\left(\frac{Im(Z)}{Re(Z)}\right)
    $$
    Фаза должна находиться в допустимом диапазоне от \(-90^\circ\) до \(+90^\circ\).
  - Расчёт сопротивления:
    $$
    R = T \cdot Z^2
    $$
    где \(T\) – период измерения (столбец `x`).
- **Фильтрация выбросов.** Использование алгоритмов Isolation Forest, анализа z‑score, а также дополнительных физических проверок:
  - Монотонность импеданса (не должно резко возрастать).
  - Допустимый угол наклона (не более 40°).
  - Согласованность между 8 кривыми (стандартное отклонение не должно превышать 1.5).
- **Сглаживание и интерполяция.** Применение сплайн-интерполяции для получения центральной кривой, проходящей через данные.
- **Модель машинного обучения.** Создание многоканальной нейронной сети:
  - Входные данные представлены в виде 3D-массива размерности $$ (N \times 8 \times 2) $$, где 2 признака – это импеданс и фаза.
  - Целевые данные также представлены в виде $$(N \times 8 \times 2)$$ (impedance и resistance).
  - Модель имеет выходной слой из 16 нейронов (8 кривых × 2 параметра) и использует среднеквадратичную ошибку (MSE) как функцию потерь.
- **API и визуализация.** Реализация REST API с FastAPI для загрузки данных, обучения модели, предсказаний и визуализации результатов с автоматической документацией.
- **Контейнеризация.** Упаковка приложения в Docker-образ с Docker Compose для упрощения развертывания и масштабирования.
- **Хранение данных.** Использование SQLite для сохранения истории обучения и предсказаний.

## Техническая архитектура

### Основные компоненты

- **DataGenerator:**  
  Генерирует синтетические данные для тестирования системы. Для каждой точки измерения создаётся 8 кривых, где для каждой кривой рассчитываются:
  - **impedance** – измеренное значение,
  - **phase** – значение фазы,
  - **resistance** – рассчитывается по формуле 
 
    $$
    ( R = T \cdot Z^2 ), где (T)
    $$
   – период (значение столбца `x`).

- **DataProcessor:**  
  - Агрегирует данные с 8 кривых (усреднение для получения базовых столбцов `impedance`, `phase`, `resistance`).
  - Производит проверку физической корректности:
    - Удаляет строки, где фаза выходит за диапазон $$([-90^\circ, +90^\circ])$$
    - Удаляет строки с отрицательными значениями импеданса.
    - Проверяет монотонность изменения импеданса.
    - Проверяет, что угол наклона кривой не превышает 40°.
    - Проверяет согласованность между кривыми (стандартное отклонение менее 1.5).
  - Применяет итеративную фильтрацию (Isolation Forest + z‑score) для удаления выбросов, с возможностью смягчения фильтрации, если осталось слишком мало данных.
  - Выполняет нормализацию данных по всем релевантным столбцам с использованием Z‑score.

- **ModelTrainer:**  
  - Преобразует данные в 3D массивы для обучения (вход
  $$ (X): (N \times 8 \times 2);
  $$ 
  $$
   целевые (Y): (N \times 8 \times 2))
   $$
  - Разрабатывает нейронную сеть с использованием Dense-слоёв, Batch Normalization и Dropout. Выходной слой имеет 16 нейронов.
  - Использует кастомную функцию потерь, рассчитывающую среднеквадратичную ошибку для всего вектора.
  - Обучает модель, сохраняя историю обучения и итоговую модель в файловой системе.

- **Visualizer:**  
  Предоставляет функции для построения графиков:
  - Графики исходных и сглаженных кривых.
  - Графики распределения данных до и после фильтрации.
  - Графики ошибок (loss, MAE) во время обучения.
  - Панельные графики для нескольких кривых одновременно.

- **API (FastAPI):**  
  Реализует набор эндпоинтов:
  - Загрузка CSV-файла с данными.
  - Обучение модели (с сохранением истории и SQLite для хранения записей).
  - Предсказание на основе загруженных данных.
  - Визуализация предсказаний и результатов обработки.
  - Получение истории обучения.

### Архитектурная схема

Приложение реализовано как микросервисное серверное приложение на FastAPI. Все компоненты (генерация данных, предобработка, обучение, визуализация) написаны на Python. Для хранения данных используется SQLite, что упрощает развертывание и не требует сложной настройки СУБД. Приложение упаковывается в Docker-образ, а Docker Compose используется для быстрого развертывания.

## Установка и запуск

### Требования

- Docker и Docker Compose
- Git (опционально)

### Установка

1. Клонируйте репозиторий:
   ```bash
   git clone git@github.com:ITech7750/mtz.git
   cd mtz
   ```

2. Проверьте файл `requirements.txt` для установки всех зависимостей.

### Запуск с Docker Compose

1. Соберите и запустите контейнеры:
   ```bash
   docker-compose up --build
   ```
2. Приложение будет доступно по адресу: [http://localhost:8080](http://localhost:8080)

### Локальный запуск без Docker

1. Создайте виртуальное окружение и установите зависимости:
   ```bash
   python3 -m venv myenv
   source myenv/bin/activate
   pip install -r requirements.txt
   ```
2. Запустите приложение:
   ```bash
   uvicorn tmp:app --host 0.0.0.0 --port 8080
   ```

## Использование API

- **GET /**  
  Проверка работы сервиса.

- **POST /upload_data**  
  Загрузка CSV-файла с данными.

- **GET /get_data**  
  Получение загруженного CSV-файла.

- **POST /train_model**  
  Обучение модели. Подается имя файла (через form-data) и параметр `retrain`.

- **POST /predict**  
  Предсказание на основе загруженного CSV-файла.

- **POST /predict_visual**  
  Визуализация предсказаний.

- **GET /visualize_full**  
  Построение сводной визуализации: графики исходных и сглаженных кривых, ошибок обучения.

- **GET /get_history**  
  Получение истории обучения из SQLite.

- **GET /visualize_full_panels**  
  Построение панели с несколькими графиками для выбранных кривых.

## Физические критерии обработки данных

В процессе предобработки данные проходят следующие проверки:

- **Сходимость дисперсионных соотношений.**  
  Усреднение значений 8 кривых и проверка стандартного отклонения.

- **Монотонность импеданса.**  
  Импеданс не должен резко возрастать (с допуском в 10%).

- **Угол наклона кривой.**  
  Угол наклона изменения импеданса должен быть не более 40°.

- **Допустимый диапазон фазы.**  
  Фаза для каждой кривой должна находиться в диапазоне от \(-90^\circ\) до \(+90^\circ\).

- **Согласованность между кривыми.**  
  Стандартное отклонение между 8 кривыми не должно превышать 1.5 (после нормализации).

## Модель машинного обучения

Модель представляет собой глубокую нейронную сеть, которая имеет следующие особенности:

- Входные данные представляют собой 3D-массивы размерности $$(N \times 8 \times 2) $$ (где 2 признака – impedance и phase), а целевые данные – $$(N \times 8 \times 2)$$ (impedance и resistance).
- Архитектура включает несколько Dense-слоёв с активацией ReLU, Batch Normalization и Dropout.
- Выходной слой имеет 16 нейронов (8 кривых × 2 параметра).
- Используется кастомная функция потерь (среднеквадратичная ошибка по всему вектору).

## Контейнеризация

Проект упаковывается в Docker-образ, что обеспечивает:
- Легкость развертывания и быструю настройку.
- Изоляцию среды выполнения.
- Использование SQLite для хранения истории обучения и модели.

Пример файлов Dockerfile и docker-compose.yml приведены ниже.

**Dockerfile**

```dockerfile
FROM python:3.9-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install --upgrade pip && pip install -r requirements.txt
COPY . .
EXPOSE 8080
CMD ["uvicorn", "tmp:app", "--host", "0.0.0.0", "--port", "8080"]
```

**docker-compose.yml**

```yaml
version: "3.8"
services:
  app:
    build: .
    container_name: mtz_app
    ports:
      - "8080:8080"
    volumes:
      - .:/app
```



